#!/usr/bin/env python
import json
import getpass
import os

import keyring
import click
import requests

PROMPT = 'prompt'
KEYRING = 'keyring'
TESTING = 'testing'
PASSWORD_PROVIDERS = [PROMPT, KEYRING, TESTING]


class CMDLineExit(Exception):
    pass


def prompt_get_password(username):
    """Return password for the given user"""
    return getpass.getpass("Password for {0}: ".format(username))


def keyring_get_password(username):

    keyring_impl = keyring.get_keyring()

    # TODO: there has got to be a better way
    description = '.'.join((keyring_impl.__class__.__module__,
                            keyring_impl.__class__.__name__))
    debug("Note: will use the backend: '{0}'".format(keyring_impl))
    password = keyring.get_password('cbas', username)
    if not password:
        info("No password found in keychain, please enter it now to store it.")
        password = prompt_get_password(username)
        keyring.set_password('cbas', username, password)
    return password


def get_password(password_provider, username):
    if password_provider == PROMPT:
        password = prompt_get_password(username)
    elif password_provider == KEYRING:
        password = keyring_get_password(username)
    elif password_provider == TESTING:
        password = 'PASSWORD'
    else:
        raise CMDLineExit("'{0}' is not a valid password provider.\n".
                          format(password_provider) +
                          "Valid options are: {0}".
                          format(PASSWORD_PROVIDERS))

    return password


def obtain_access_token(auth_url, username, password):
    auth_request_data = {'client_id': 'jumpauth',
                         'client_secret': '',
                         'username': username,
                         'password': password,
                         'grant_type': 'password'}
    auth_response = requests.post(auth_url, auth_request_data)
    auth_response.raise_for_status()
    access_token = auth_response.json()['access_token']
    click.echo("Access token: '{0}'".format(access_token))
    return access_token


def get_username(args):
    return args['username'] if args['username'] else getpass.getuser()


def get_password():


@click.group()
def main():
    pass


@main.command()
@click.option('--auth-url')
@click.option('--username')
@click.option('--sshkey')
@click.option('--password', prompt=True, hide_input=True)
@click.argument('jumphost')
def upload(**kwargs):
    if not kwargs['sshkey']:
        ssh_key_path = os.environ['HOME'] + '/.ssh/id_rsa.pub'
    else:
        ssh_key_path = kwargs['sshkey']

    ssh_key_filehandle = open(ssh_key_path, "r")
    ssh_key = ssh_key_filehandle.readline()
    ssh_key_filehandle.close()


    print(username)
    print(ssh_key)
    username = get_username(kwargs)
    auth_url = kwargs['auth-url']
    password = kwargs['kwargs']
    access_token = obtain_access_token(auth_url, username, password)

    jump_request_header = {'Authorization': 'Bearer ' + access_token,
                           'Content-Type': 'application/json',
                           'Cache-Control': 'no-cache'}
    jump_request_data = json.dumps({"pubkey": ssh_key})
    jump_url = 'https://' + kwargs['jumphost'] + '/create'
    print(jump_url)

    jump_response = requests.post(jump_url,
                                  jump_request_data,
                                  headers=jump_request_header)
    jump_response.raise_for_status()
    print(jump_response.text)


@main.command()
@click.option('--auth-url')
@click.option('--username')
@click.option('--client-secret')
@click.argument('jumphost')
def delete(**kwargs):
    access_token = obtain_access_token(auth_url, username, password)
    jump_request_header = {'Authorization': 'Bearer ' + access_token,
                           'Content-Type': 'application/json',
                           'Cache-Control': 'no-cache'}
    jump_url = 'https://' + kwargs['jumphost'] + '/delete'

    jump_response = requests.post(jump_url, headers=jump_request_header)
    jump_response.raise_for_status()

if __name__ == '__main__':
    main()
